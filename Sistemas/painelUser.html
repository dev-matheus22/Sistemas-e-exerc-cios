<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel do Usu√°rio</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://unpkg.com/intro.js/minified/introjs.min.css" rel="stylesheet">
  <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/Draggable.min.js"></script>
  <link rel="shortcut icon" href="iconSapo.png" type="image/x-icon">
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&display=swap');
  @import url('https://fonts.googleapis.com/css2?family=Montserrat+Alternates:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');

      html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: transparent;
    }
    
    * {
      box-sizing: border-box;
    }

  body {
    display: flex;
    flex-direction: column;
    height: 100vh;
    background: linear-gradient(135deg, #A8E6CF, #DCEDC1);    
    font-family: 'Montserrat Alternates', sans-serif;
    width: 100%;
    margin-top: 0px;
    position: relative;
    overflow-y: auto;
    overflow-x: hidden;
  }

  .painel-usuario {
    flex-grow: 1;
    width: 100%;
    padding: 40px 20px;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    margin-top: 30px;
  }

  .cor-navbar {
    background-color: #E0F7FA;
  }

  .fonte {
    font-family: 'Dancing script';
    color: #5e35b1;
  }

  .painel-usuario-bg {
    background: linear-gradient(135deg, #A8E6CF, #DCEDC1);
  }

  .card {
    margin-top: 20px;
    background-color:  #E0F7FA;
    padding: 20px;
    border-radius: 8px;
    width: 100%;
    max-width: 800px;
  }

  .botoes-usuario {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: space-around;
    margin-bottom: 30px;
  }

  .botao-acao {
    border: none;
    padding: 15px 20px;
    border-radius: 12px;
    color: white;
    font-weight: bold;
    transition: all 0.2s ease-in-out;
    box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
    min-width: 200px;
    text-align: center;
  }

  .botao-acao:hover { transform: scale(1.08); cursor: pointer; }

  .botao-acao-enviar { background-color: #f44336; }
  .botao-acao-enviar:hover { background-color: #d32f2f; }

  .botao-acao-sugestoes { background-color: #2196f3; }
  .botao-acao-sugestoes:hover { background-color: #1976d2; }

  .botao-acao-relatar { background-color: #ff9800; }
  .botao-acao-relatar:hover { background-color: #f57c00; }

  .botao-acao-confirmar { background-color: #4caf50; }
  .botao-acao-confirmar:hover { background-color: #388e3c; }

  .botao-acao-criar-template { background-color: #9c27b0; }
  .botao-acao-criar-template:hover { background-color: #7b1fa2; }

  .botao-acao-sair { background-color: #6c757d; }
  .botao-acao-sair:hover { background-color: #495057; }

  #formBug, #formTemplate, #formCorreioElegante, #formConfirmarPresenca {
    display: none;
    background-color:  #E0F7FA;
    padding: 20px;
    margin-top: 20px;
  }

  .heart-effect {
    color: red;
    font-size: 2rem;
    animation: heartPulse 1s infinite;
  }

  .bg-correio-elegante {
    background: linear-gradient(135deg, #FF6F61, #D9A2A3);
  }

  .bg-editar-perfil {
    background: linear-gradient(135deg, #6F61FF, #A2A3D9);
  }

  .bg-relatar-bug {
    background: linear-gradient(135deg, #F57C00, #eb821a);
  }

  .bg-confirmar-presenca {
    background: linear-gradient(135deg, #61FF8D, #A3D9A2);
  }

  .bg-criar-template {
    background: linear-gradient(135deg, #7B1FA2, #6b2888);
  }
  
  .bg-emblemas {
    background: linear-gradient(135deg, #FFD700, #FFB800);
  }
  
  .bg-depoimentos{
    background: linear-gradient(135deg, #FD99A2, #FC6C85);
  }
  
  .bg-testar-quimica{
    background: linear-gradient(135deg, #8e2de2, #ff6ec4);
  }

  @keyframes heartPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.5); opacity: 0.5; }
    100% { transform: scale(1); opacity: 1; }
  }

  .customTooltip {
    background-color: #E0F7FA;
    color: #333;
    border-radius: 10px;
    padding: 15px;
    font-size: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .introjs-tooltip-title {
    font-weight: bold;
    color: #0d6efd;
  }

  .introjs-button {
    border-radius: 8px;
    padding: 8px 12px;
  }

  .introjs-skipbutton {
    color: #dc3545 !important;
  }

  .footer-content {
    max-width: 1200px;
    margin: 0;
    text-align: center;
    color: #5e35b1;
    font-weight: bold;
  }
  
  .footer-custom {

    width: 100%;

    background-color: #E0F7FA;

    padding: 20px 30px;

    margin-top: 30px;

    text-align: center;

    font-weight: bold;

    display: flex;

    justify-content: center;

    align-items: center;

  }

  form, form label, form input, form textarea, form select, p > strong {
    color: #5e35b1;
  }

  .navbar-nav .btn {
    border: 2px solid #7e57c2;
    border-radius: 8px;
    padding: 8px 16px;
    background-color: transparent;
    color: #7e57c2;
    transition: background-color 0.3s, color 0.3s;
  }

  .navbar-nav .btn:hover {
    background-color: #7e57c2;
    color: white;
  }

  .navbar .container-fluid {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .navbar-brand {
    margin-right: 30px;
  }

  .fonte{
      font-family: 'Dancing script';
      color: #5e35b1;
  }
  
    .text-center {
      color:  #7e57c2;
  }
  
  .text-paragrafo {
      color:  #7e57c2;
  }

.header-usuario {
  display: flex;
  flex-wrap: wrap; /* <- ADICIONE ESTA LINHA */
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  padding: 0 10px;
  gap: 10px; /* opcional: adiciona espa√ßamento entre linhas no wrap */
}

#statusUsuario {
  max-width: 100%;
  min-width: 160px;
}

#pontosUsuario {
  font-weight: bold;
  color: #388e3c;
  background-color: #e8f5e9;
  padding: 6px 12px;
  border-radius: 12px;
  box-shadow: 1px 1px 4px rgba(0,0,0,0.1);
  white-space: nowrap; /* impede quebra interna */
  overflow-x: auto;
  max-width: 100%;
}

#bemVindo {
  margin: 0;
  font-size: 1.5rem;
  color: #5e35b1;
  text-align: center;
}

#pontosUsuario {
  font-weight: bold;
  color: #388e3c;
  background-color: #e8f5e9;
  padding: 6px 12px;
  border-radius: 12px;
  box-shadow: 1px 1px 4px rgba(0,0,0,0.1);
}

.emblema {
  width: 70px;  /* Tamanho pequeno */
  height: 70px; 
  margin-right: 10px;
  margin-bottom: 10px;
  border-radius: 50%; /* Bordas arredondadas */
  background-color: #E0F7FA;

}

#musicListContainer {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  padding: 10px;
  gap: 10px; /* controla o espa√ßamento entre itens */
}

.music-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  flex: 0 0 19%; /* Cada item pega aproximadamente 19% com margem de seguran√ßa */
  box-sizing: border-box;
  padding: 5px;
  text-align: center;
  background-color: #E0F7FA;
  border-radius: 6px;
}


/* Imagem da m√∫sica */
.music-image {
  width: 40px;
  height: auto;
  max-height: 40px;
  object-fit: cover;
  margin-top: 8px;
  border-radius: 6px;
}
  
  @media (max-width: 768px) {

.navbar-collapse {
    position: absolute;
    top: 60px;
    right: 0;
    background-color: #E0F7FA;
    border-radius: 10px;
    width: 100%;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
}


  .navbar-nav {
    flex-direction: column;
    align-items: flex-end !important;/* faz os bot√µes se alinharem √† direita */
  }
}

</style>
</head>
<body>
  <nav class="navbar navbar-expand-lg  cor-navbar fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">
           <img src="Logo.webp" alt="" width="40" height="40" class="d-inline-block align-text-top">
            <span class="fonte">Beija Sapo</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav gap-2" style="margin-left: -270px;">
             <li class="nav-item">
            <a class="btn" href="index.html" style="color: #7e57c2;">
              <i class="bi bi-house-door"></i> Home
            </a>
          </li>
          <li class="nav-item">
            <a class="btn" href="loginAdm.html" style="color: #7e57c2;">
              <i class="bi bi-shield-lock"></i> Adm
            </a>
          </li>
          <li class="nav-item">
            <a class="btn" href="loginUser.html" style="color: #7e57c2;">
              <i class="bi bi-person"></i> Usu√°rio
            </a>
          </li>
          <li class="nav-item">
            <a class="btn" href="cadastroUsuario.html" style="color: #7e57c2;">
              <i class="bi bi-person-plus"></i> Cadastre-se
            </a>
          </li>
          <li class="nav-item">
            <a class="btn" href="galeria.php" style="color: #7e57c2;">
              <i class="bi bi-image"></i> Galeria
            </a>
          </li>
         
        </ul>
      </div>
    </div>
  </nav>

    <div class="painel-usuario">
      <div class="card">
        <div class="header-usuario">
          <h4 id="bemVindo">Bom te ver, sapinho üê∏!</h4>

          <div style="flex-grow: 1; text-align: center;">
          <select id="statusUsuario" class="form-select" value="status"
          data-intro="Se√ß√£o status"
          data-step="1" style="background: linear-gradient(90deg, #ffc0cb, #dabfff); color: #555;">
            <option selected disabled>Status</option>
            <option value="true">T√¥ na pista</option>
            <option value="false">Hoje n√£o, Faro!</option>
          </select>
        </div>

          <span id="pontosUsuario" data-intro="se√ß√£o pontos" data-step="2">0 pts</span>
        </div>
    
        <div class="botoes-usuario">
          <button class="botao-acao botao-acao-enviar drag-btn" id="btnEnviarCorreioElegante"
            data-intro="Clique aqui para enviar um correio elegante para algu√©m do grupo!"
            data-step="3">
            <i class="bi bi-envelope"></i> Enviar correio elegante
          </button>
        
          <button class="botao-acao botao-acao-sugestoes drag-btn" id="btnVerPerfil"
            data-intro="Aqui voc√™ pode ver ou editar seu perfil."
            data-step="4">
            <i class="bi bi-pencil"></i> Editar perfil
          </button>
        
          <button class="botao-acao botao-acao-relatar drag-btn" id="relatarBugBtn"
            data-intro="Encontrou um erro? Relate um bug por aqui!"
            data-step="5">
            <i class="bi bi-bug"></i> Relatar um bug
          </button>
        
          <button class="botao-acao botao-acao-confirmar drag-btn" id="btnConfirmarPresenca"
            data-intro="Use esse bot√£o para confirmar sua presen√ßa nos rol√™s!"
            data-step="6">
            <i class="bi bi-calendar-check"></i> Confirmar presen√ßa
          </button>
        
          <button class="botao-acao botao-acao-criar-template drag-btn" id="btnCriarTemplate"
            data-intro="Aqui voc√™ pode criar seu template de apresenta√ß√£o. Bem-vinde, sapinho!"
            data-step="7">
            <i class="bi bi-plus-circle"></i> Criar Template
          </button>
        
          <button id="btnEmblemas" class="botao-acao botao-acao-emblemas drag-btn" style="background-color: #FFD700; color: #fff;"
          data-intro="Se√ß√£o dos emblemas";
          data-step="8">
            <i class="bi bi-award"></i> Emblemas
        </button>
        
        <li class="nav-item dropdown list-unstyled">
          <a class="btn botao-acao dropdown-toggle position-relative" id="btnDepoimentos" href="#" id="dropdownDepoimentos" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="background-color: #FD99A2; color: #fff;"
          data-intro="Se√ß√£o dos depoimentos"
          data-step="9">
            <i class="bi bi-chat-dots"></i> Depoimentos
              <span id="badgeDepoimentos" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">!</span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownDepoimentos">
            <li><a class="dropdown-item" href="#" id="verDepoimentos"><i class="bi bi-eye"></i> Ver depoimentos</a></li>
            <li><a class="dropdown-item" href="#" id="escreverDepoimento"><i class="bi bi-pencil-square"></i> Escrever depoimento</a></li>
          </ul>
        </li>

        <div class="dropdown text-center">
          <a class="btn botao-acao dropdown-toggle" data-bs-toggle="dropdown" id="btnTestarQuimica" style="background: linear-gradient(135deg, #8e2de2, #ff6ec4);"
          data-intro="Se√ß√£o dos matches"
          data-step="10">
            <i class="bi bi-heart-pulse-fill"></i> Testar a qu√≠mica
          <a>
          <ul class="dropdown-menu text-center">
          <li><a class="dropdown-item" href="#" id="verEnviados">Hops enviados</a></li>
          <li><a class="dropdown-item" href="#" id="verRecebidos">Hops recebidos</a></li>
          <li><a class="dropdown-item" href="#" id="verMatches">Matches</a></li>
          <li><a class="dropdown-item" href="#" id="btnTestarQuimica">Usu√°rios online</a></li>
        </ul>
        </div>
        
        <button id="btnSecrets" class="botao-acao botao-acao-secrets drag-btn" style="background-color: #555; color: #fff;"
          data-intro="Se√ß√£o dos segredos";
          data-step="#">
            <i class="bi bi-key"></i> Secrets
        </button>
        
          <button class="botao-acao botao-acao-sair drag-btn" id="btnSair"
            data-intro="Clique aqui para sair do painel."
            data-step="11">
            <i class="bi bi-door-open"></i> Sair
          </button>
        </div>

    
        <!-- Formul√°rio de Correio Elegante -->
        <div id="formCorreioElegante">
          <h5 class="text-center">‚ù§Ô∏è Enviar Correio Elegante ‚ù§Ô∏è</h5>
          <p class="text-center">Utilize essa se√ß√£o para enviar aquela paquera para algu√©m do grupo!</p>
          <form id="correioForm">
            <div class="mb-3">
              <label for="destinatario" class="form-label">Destinat√°rio</label>
              <input type="text" class="form-control" id="destinatario" required placeholder="@fulano ou apenas fulano">
            </div>
            <div class="mb-3">
              <label for="remetente" class="form-label">Remetente</label>
              <input type="text" class="form-control" id="remetente" required placeholder="Seu nome ou an√¥nimo">
            </div>
            <div class="mb-3">
              <label for="mensagem" class="form-label">Mensagem</label>
              <textarea class="form-control" id="mensagem" rows="4" required  placeholder="Agora √© a hora xD"></textarea>
            </div>
            <button type="submit" class="btn btn-warning">Enviar</button>
          </form>
          <div id="correioStatus" class="mt-2 text-success" style="display:none;">Mensagem enviada com sucesso! <span class="heart-effect">‚ù§Ô∏è</span></div>
        </div>

        <!-- Formul√°rio de editar perfil -->

    
        <!-- Formul√°rio de Bug -->
        <div id="formBug">
          <h5 class="text-center">Relatar um Bug</h5>
          <p class="text-center">Encontrou um bug? Relate aqui!</p>
          <form id="bugForm">
            <div class="mb-3">
              <label for="titulo" class="form-label">T√≠tulo</label>
              <input type="text" class="form-control" id="titulo" required>
            </div>
            <div class="mb-3">
              <label for="descricao" class="form-label">Descri√ß√£o</label>
              <textarea class="form-control" id="descricao" rows="4" required></textarea>
            </div>
            <button type="submit" class="btn btn-warning">Enviar Bug</button>
          </form>
          <div id="bugStatus" class="mt-2 text-success" style="display:none;">Bug enviado com sucesso!</div>
        </div>
    

        <!-- Formul√°rio de Template -->
        <div id="formTemplate" class="container mt4"> 
          <form id="templateForm">
            <h5 class="text-center">Criar template</h5>
            <p class="text-center">Gere seu template de apresenta√ß√£o aqui, mas lembre-se de adicionar sua foto ao template do whatsapp</p>
            <br>
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label">Nome:</label>
                <input type="text" class="form-control" id="nome">
              </div>

              <div class="col-md-4">
                <label class="form-label">Idade:</label>
                <input type="text" class="form-control" id="idade">
              </div>

              <div class="col-md-4">
                <label class="form-label">Anivers√°rio:</label>
                <input type="text" class="form-control" id="aniversario">
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Signo:</label>
                <input type="text" class="form-control" id="signo">
              </div>

              <div class="col-md-6">
                <label class="form-label">Altura:</label>
                <input type="text" class="form-control" id="altura">
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-4">
                <label class="form-label">Cidade e Bairro (SP):</label>
                <input type="text" class="form-control" id="cidadeBairro">
              </div>

              <div class="col-md-4">
                <label class="form-label">Estado Civil:</label>
                <input type="text" class="form-control" id="estadoCivil">
              </div>

              <div class="col-md-4">
                <label class="form-label">Instagram:</label>
                <input type="text" class="form-control" id="instagram">
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-12">
                <label class="form-label">Hobbies:</label>
                <input type="text" class="form-control" id="hobbies">
              </div>
            </div>
            <button type="button" class="btn btn-success" id="gerarTemplate">Gerar Template</button>
          </form>
        </div>

    
        <div id="resultadoTemplate" style="display: none; white-space: pre-line; margin-top: 20px;"></div>
        <button id="copiarTexto" class="btn btn-secondary mt-3" style="display: none;">Copiar texto</button>
        
       <div id="perfilContainer">
        <div class="card">
        <h5 class="text-center mb-4">Veja ou edite suas informa√ß√µes aqui!</h5>
        <div class="card-body">
          <div class="text-center my-3">
            <img id="fotoPerfil" src="default.png" class="rounded-circle mb-2" style="width: 150px; height: 150px; object-fit: cover;" alt="Foto de Perfil">
            <br>
            <button id="btnAlterarFoto" class="btn btn-primary btn-sm mt-2">üñºÔ∏è Alterar foto de perfil</button>
            <input type="file" id="uploadFoto" class="form-control mt-2" accept="image/*" style="display: none;">
          </div>

      <p><strong>Nome:</strong> <span id="perfilNome"></span> <button class="btn btn-warning btn-sm" id="editNome" style="color: #fff">‚úèÔ∏è Editar</button></p>
      <p>
      <strong>SapoId:</strong>
      <span id="perfilUsername"></span>
      <input type="text" id="inputUsername" class="form-control d-none mt-2" placeholder="Novo username">
      <button class="btn btn-warning btn-sm" id="editUsername" style="color: #fff">‚úèÔ∏è Editar</button>
      <button class="btn btn-success btn-sm d-none mt-2" id="salvarUsername">üíæ Salvar</button>
      </p>
      <p><strong>Cidade:</strong> <span id="perfilCidade"></span> <button class="btn btn-warning btn-sm" id="editCidade" style="color: #fff">‚úèÔ∏èÔ∏è Editar</button></p>
      <p><strong>Telefone:</strong> <span id="perfilTelefone"></span> <button class="btn btn-warning btn-sm" id="editTelefone" style="color: #fff">‚úèÔ∏è Editar</button></p>
      <p><strong>Idade:</strong> <span id="perfilIdade"></span> <button class="btn btn-warning btn-sm" id="editIdade" style="color: #fff">‚úèÔ∏è Editar</button></p>
      <p><strong>Email:</strong> <span id="perfilEmail"></span> <button class="btn btn-warning btn-sm" id="editEmail" style="color: #fff">‚úèÔ∏è Editar</button></p>
      <p><strong>Sobre Voc√™:</strong> <span id="perfilSobre"></span> <button class="btn btn-warning btn-sm" id="editSobre" style="color: #fff">‚úèÔ∏è Editar</button></p>
      <h5 class="text-center">üéµ M√∫sica do Perfil</h5>
        <p class="text-paragrafo">Conecte-se com sua conta do Spotify e escolha a m√∫sica que aparecer√° no seu perfil.</p>
        <div id="musicSection" style="display: none;"> <!-- Se√ß√£o para mostrar as m√∫sicas depois da conex√£o -->
          <h5 class="text-center">Minhas M√∫sicas Mais Tocadas:</h5>
          <ul style="list-style: none;" id="musicListContainer" class="text-paragrafo"> <!-- Container onde as m√∫sicas/artistas ser√£o listados -->
            <!-- As m√∫sicas ser√£o inseridas aqui dinamicamente -->
          </ul>
        </div>
        <button id="loginSpotify" class="btn btn-success">Conectar com Spotify <i class="bi bi-spotify"></i></button>
        
        

    </div>
  </div>
</div>

        <!-- Formul√°rio Confirmar Presen√ßa -->
        <div id="formConfirmarPresenca" style="display: none;">
          <h5 class="text-center">Confirme sua presen√ßa</h5>
          <p class="text-center">Vai no rol√™? Confirme aqui sua presen√ßa!</p>
          <div id="rol√™Info">
            <p style="color: #5e35b1;">Rol√™: <span id="nomeRole"></span></p>
            <p style="color: #d3c15e;">Data: <span id="dataRole"></span></p>
          </div>
          <div class="text-center">
            <button id="btnVou" class="btn btn-success me-2">Vou</button>
            <button id="btnNaoVou" class="btn btn-danger">N√£o vou</button>
          </div>
          <div id="presencaStatus" class="mt-2 text-success text-center" style="display:none;">
            Presen√ßa confirmada!
          </div>
          <div id="presencaStatusNao" class="mt-2 text-danger text-center" style="display:none;">
           Ent√£o t√°!
          </div>
        </div>
        
        
        
        <!--Depoimentos-->

        <form id="formDepoimentos" style="display: none;" class="card">
            <h5 class="text-center">Escreva um depoimento para outro sapinho!</h5>
            <br>
          <div class="mb-3">
            <label for="tituloDepoimento" class="form-label">T√≠tulo do Depoimento</label>
            <input type="text" class="form-control" id="tituloDepoimento" placeholder="Ex: Amizade especial">
          </div>
        
          <div class="mb-3">
            <label for="usuarioDepoente" class="form-label">Seu nome de usu√°rio</label>
            <input type="text" class="form-control" id="usuarioDepoente" placeholder="Ex: sapinho_fofo">
          </div>
        
          <div class="mb-3">
            <label for="usuarioDestino" class="form-label">Enviar para</label>
            <select class="form-select" id="usuarioDestino">
              <option selected disabled>Selecione um usu√°rio</option>
              <!-- As op√ß√µes ser√£o preenchidas via JS -->
            </select>
          </div>
        
          <div class="mb-3">
            <label for="textoDepoimento" class="form-label">Seu Depoimento</label>
            <textarea class="form-control" id="textoDepoimento" rows="5" placeholder="Conte algo especial..."></textarea>
          </div>
        
          <button type="submit" class="btn btn-primary" style="background-color: #5e35b1; border-color: #5e35b1;">
            Enviar Depoimento
          </button>
        </form>

        <div id="listaDepoimentos" class="card mt-3 p-3" style="display: none;">
          <h5 class="text-center">Depoimentos recebidos</h5>
          <div id="depoimentosContainer"></div>
        </div>

        <form id="formTestarQuimica" style="display: none; background-color: #E0F7FA; padding: 20px; margin-top: 20px; border-radius: 8px;" class="mx-auto mt-3" autocomplete="off">
          <div class="mb-3">
            <p id="contadorDisponiveis" class="text-center mt-2 text-muted"></p>
            <label for="selectUsuarios" class="form-label">Escolha o sapinho:</label>
            <div id="previewUsuarioSelecionado" class=" mb-2"></div>
            <select class="form-select" id="selectUsuarios" required>
              <option selected disabled>Selecionar usu√°rio</option>
              <!-- Op√ß√µes reais ser√£o inseridas aqui via JavaScript -->
            </select>
          </div>
          <button type="submit" class="btn botao-acao botao-acao-enviar">
            <i class="bi bi-envelope-heart"></i> Enviar hop
          </button>
        </form>
        <div id="convitesContainer" class="mt-3"></div>
        <div id="matchesContainer" class="mt-3" style="display: none;"></div>
        
        <!-- Chat-->
        
        <div id="chatContainer" class="card mt-3 p-3" style="display: none;">
          <h5 id="chatTitulo"></h5>
          <div id="chatMensagens" class="border p-3 mb-3" style="height: 200px; overflow-y: auto;"></div>
          <div class="input-group">
  <!-- Bot√£o para selecionar imagem -->
          <button class="btn btn-outline-secondary" id="btnIconeImagem" type="button" title="Enviar imagem">
                  <i class="bi bi-image"></i>
          </button>
        
          <!-- Campo de digitar mensagem -->
          <input type="text" class="form-control" id="mensagemInput" placeholder="Digite sua mensagem...">
        
          <!-- Bot√£o de enviar texto -->
          <button class="btn btn-success" id="btnEnviar">Enviar</button>
        
          <!-- Campo oculto de sele√ß√£o de imagem -->
          <input type="file" id="imagemInput" accept="image/*" style="display: none;">
        </div>
        </div>


        <!-- // Secrets -->
         <div id="secretsContainer" class="card mt-3 p-3" style="display: none;">
            <h5 class="text-center">Conte-nos um segredo!</h5>
            <div class="mb-3">
            <label for="secrets" class="form-label">Seu segredo</label>
            <textarea class="form-control" id="secrets" rows="5" placeholder="Conte algo secreto..."></textarea>
            <button id="enviarSegredo" class="btn btn-primary">Enviar</button>
          </div>
         </div>

        
        <div id="emblemasSection" style="display: none;">
            <div class="card" style="border-radius: 8px; background-color: #E0F7FA; padding: 15px;">
                <h3 class=text-center>Emblemas</h3>
            <div id="emblemasContainer" style="display: flex; flex-wrap: wrap; gap: 10px;">
      <!-- Aqui os emblemas ser√£o exibidos -->
            </div>
        </div>
      </div> <!-- fecha .card -->
      
      
    </div>
    </div> <!-- fecha .painel-usuario -->
    
    <footer class="footer-custom">
  <div class="footer-content">
        <p>¬© 2025 Beija Sapo - Todos os direitos reservados</p>
      <p>Desenvolvido com üíú para o grupo</p>  </div>
</footer>

    

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, updateEmail, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
  import {
  getFirestore, doc, getDoc, getDocs, setDoc, orderBy, limit,
  query, where, updateDoc, collection, addDoc, serverTimestamp, arrayUnion, deleteDoc, onSnapshot, increment,
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
  import { getStorage, ref, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";





  const firebaseConfig = {
    apiKey: "AIzaSyDkMTTM5yJbyIzjCl3vovJXx1dlNEX2IpU",
    authDomain: "beija-sapo.firebaseapp.com",
    projectId: "beija-sapo",
    storageBucket: "beija-sapo.firebasestorage.app",
    messagingSenderId: "429297677162",
    appId: "1:429297677162:web:3792b9546b7b44a16e6b13"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // Spotify
  
   document.getElementById('loginSpotify').addEventListener('click', e => {
    e.preventDefault();
    const authUrl = `https://accounts.spotify.com/authorize?` +
      `client_id=${clientId}` +
      `&response_type=code` +
      `&redirect_uri=${encodeURIComponent(redirectUri)}` +
      `&scope=${encodeURIComponent(scopes.join(' '))}`;
    window.location.href = authUrl;
  });

  const clientId    = '58aababbb9c34fb89478fc534f734a10';
  const redirectUri = 'https://beijasapo.com/painelUser.php';
  const scopes      = [
    'user-read-private',
    'user-read-email',
    'user-top-read',
    'user-read-recently-played'
  ];

  const processSpotifyCode = (code, userId) => {
    return fetch('trocar_token.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code })
    })
    .then(r => r.json())
    .then(json => {
      if (!json.access_token) {
        throw new Error(`Erro trocando token: ${JSON.stringify(json)}`);
      }
      return fetch('https://api.spotify.com/v1/me/top/tracks?limit=8', {
        headers: { 'Authorization': `Bearer ${json.access_token}` }
      });
    })
    .then(r => {
      if (!r.ok) {
        return r.json().then(err => {
          throw new Error(`Spotify API ${r.status}: ${err.error?.message || 'Unknown error'}`);
        });
      }
      return r.json();
    })
    .then(spotifyData => {
  console.log("5 Top Tracks:", spotifyData.items);

  const userTracksRef = collection(db, "usuarios", userId, "musicas_top");

  return getDocs(userTracksRef).then(snapshot => {
    const deletes = snapshot.docs.map(doc => deleteDoc(doc.ref));
    return Promise.all(deletes);
  })
  
  .then(() => {
    const saves = spotifyData.items.map(track =>
      addDoc(userTracksRef, {
        nome:      track.name,
        artista:   track.artists.map(a => a.name).join(', '),
        imagem:    track.album.images[0]?.url || '',
        timestamp: new Date()
      })
    );
    return Promise.all(saves);
  });
})
.then(() => console.log("Faixas substitu√≠das com sucesso!"))

    .then(() => console.log("Faixas salvas com sucesso!"))
    .catch(err => console.error("Erro no Spotify‚ÜíFirebase:", err));
  };
  
const displayTopTracks = (userId) => {
  const musicRef = collection(db, "usuarios", userId, "musicas_top");

  getDocs(musicRef)
    .then(snapshot => {
      const musicListContainer = document.getElementById("musicListContainer");

      musicListContainer.innerHTML = '';

      snapshot.forEach(doc => {
        const music = doc.data();
        const listItem = document.createElement('li');

        listItem.classList.add('music-item');
        listItem.innerHTML = `
        
        <div>
            <h6>${music.nome}</h6>
            <p>${music.artista}</p>
          </div>
          <img src="${music.imagem}" alt="${music.nome}" class="music-image" />
          
        `;

        musicListContainer.appendChild(listItem);
      });

      document.getElementById("musicSection").style.display = 'block';
    })
    .catch(err => {
      console.error("Erro ao buscar as m√∫sicas:", err);
    });
};

function iniciarTour() {
    introJs().setOptions({
      nextLabel: 'Pr√≥ximo',
      prevLabel: 'Voltar',
      doneLabel: 'Fechar',
      skipLabel: 'Pular',
      tooltipClass: 'customTooltip',
      steps: [
        {
          element: document.querySelector('#btnEnviarCorreioElegante'),
          intro: 'Aqui voc√™ pode mandar um correio elegante para o crush ‚ù§Ô∏è'
        },
        {
          element: document.querySelector('#btnEditarPerfil'),
          intro: '√â extremamente importante que voc√™ definnisa seu username e aqui √© o lugar pra isso!'
        },
        {
          element: document.querySelector('#relatarBugBtn'),
          intro: 'Achou algum bug estranho? Tipo... um sapo pulando no c√≥digo? Relata aqui! üêû'
        },
        {
          element: document.querySelector('#btnConfirmarPresenca'),
          intro: 'Confirme sua presen√ßa nos eventos do grupo e n√£o fique de fora! üìÖ'
        },
        {
          element: document.querySelector('#btnCriarTemplate'),
          intro: 'Chegou agora e quer se apresentar? Crie seu template aqui, novo sapinho! üê∏'
        },
        {
          element: document.querySelector("#btnEmblemas"),
          intro: 'Existem emblemas autom√°ticos, de progresso, presen√ßas em rol√™s e por pontos'
        },
        {
          element: document.querySelector("#btnDepoimentos"),
          intro: 'Quer demonstrar carinho pra um amigo? Envie um depoimento pra ele!'
        },
        {
          element: document.querySelector("#btnTestarQuimica"),
          intro: 'A vers√£o pobre do grindr, mas sem an√∫ncios! Se der match, o n√∫mero de telefone do user aparecer√° na se√ß√£o matches!'
        },
        {
          element:document.querySelector("#statusUsuario"),
          intro: 'Altere seu status para tentar um match, ou n√£o'
        },
        {
          element: document.querySelector("#pontosUsuario"),
          intro: 'Participe dos rol√™s e ganhe pontos + emblemas!'
        },
        {
          element: document.querySelector('.botao-acao-sair'),
          intro: 'Se quiser sair (mas s√≥ se for rapidinho hein?), clique aqui.'
        }
      ]
    }).start();
  }

  window.onload = function () {
  const jaViuTour = localStorage.getItem("tourVisto");

  if (!jaViuTour) {
    setTimeout(() => {
      iniciarTour();
      localStorage.setItem("tourVisto", "true");
    }, 1000);
  }
};

  
   document.getElementById("btnSair").addEventListener("click", async () => {
    try {
      await signOut(auth); 
      console.log("Usu√°rio deslogado");
      window.location.href = "index.html";  
    } catch (error) {
      console.error("Erro ao deslogar:", error);
    }
  });

    let usuarioDocId = null; 
    


const uploadFotoPerfil = async (file, userId) => {
  try {
    const storageRef = ref(storage, `fotosPerfil/${userId}.jpg`);
    await uploadBytes(storageRef, file);
    const url = await getDownloadURL(storageRef);

    const userDocRef = doc(db, "usuarios", userId);
    await updateDoc(userDocRef, { fotoPerfil: url });

    document.getElementById("fotoPerfil").src = url;
    console.log("Foto de perfil atualizada com sucesso!");
  } catch (error) {
    console.error("Erro ao fazer upload da imagem:", error);
  }
};

const editarCampo = (campoId, campoValor) => {
  const campoSpan = document.getElementById(campoId);
  const valorAtual = campoSpan.textContent;

  campoSpan.innerHTML = `<input type="text" value="${valorAtual}" id="input${campoId}" />`;

  const botaoSalvar = document.createElement("button");
  botaoSalvar.classList.add("btn", "btn-primary", "btn-sm");
  botaoSalvar.textContent = "Salvar";

  botaoSalvar.onclick = async () => {
    const novoValor = document.getElementById(`input${campoId}`).value;

    try {
      const usuarioDocRef = doc(db, "usuarios", usuarioDocId);
      await updateDoc(usuarioDocRef, {
        [campoValor]: novoValor
      });
      campoSpan.textContent = novoValor;
    } catch (error) {
      console.error("Erro ao salvar altera√ß√£o:", error);
    }
  };

  campoSpan.innerHTML += " ";
  campoSpan.appendChild(botaoSalvar);
};

// Fun√ß√£o espec√≠fica para editar username com verifica√ß√£o de duplicidade
const editarCampoUsername = (campoId, campoValor) => {
  const campoSpan = document.getElementById(campoId);
  const valorAtual = campoSpan.textContent;

  campoSpan.innerHTML = `<input type="text" value="${valorAtual}" id="input${campoId}" />`;

  const botaoSalvar = document.createElement("button");
  botaoSalvar.classList.add("btn", "btn-primary", "btn-sm");
  botaoSalvar.textContent = "Salvar";

  botaoSalvar.onclick = async () => {
    const novoValor = document.getElementById(`input${campoId}`).value.trim();

    if (!novoValor) {
      alert("O campo SapoId n√£o pode estar vazio.");
      return;
    }

    if (novoValor === valorAtual) {
      campoSpan.textContent = valorAtual;
      return;
    }

    try {
      // Verifica se j√° existe username
      const usuariosRef = collection(db, "usuarios");
      const q = query(usuariosRef, where("username", "==", novoValor.toLowerCase()));
      const querySnapshot = await getDocs(q);

      if (!querySnapshot.empty) {
        alert("Este SapoId j√° est√° em uso. Escolha outro.");
        return;
      }

      const userDocRef = doc(db, "usuarios", usuarioDocId);
      await updateDoc(userDocRef, {
        [campoValor]: novoValor.toLowerCase()
      });

      campoSpan.textContent = novoValor;
      alert("SapoId atualizado com sucesso!");
    } catch (error) {
      console.error("Erro ao atualizar username:", error);
      alert("Erro ao atualizar SapoId.");
    }
  };

  campoSpan.innerHTML += " ";
  campoSpan.appendChild(botaoSalvar);
};

  let currentMatchId = null;
    let unsubscribe = null;
    let uid = null;



// Observa altera√ß√µes na autentica√ß√£o do Firebase
onAuthStateChanged(auth, async (user) => {
  if (user) {
    uid = user.uid;
    console.log("Usu√°rio logado:", uid);
            displayTopTracks(uid);


    try {
      // Carrega dados do perfil
      const usuariosRef = collection(db, "usuarios");
      const q = query(usuariosRef, where("userId", "==", uid));
      const querySnapshot = await getDocs(q);

      if (!querySnapshot.empty) {
        const documento = querySnapshot.docs[0];
        const data = documento.data();
        usuarioDocId = documento.id;

        // Preenche campos do perfil
        document.getElementById("perfilNome").textContent = data.nome;
        document.getElementById("perfilCidade").textContent = data.cidade;
        document.getElementById("perfilTelefone").textContent = data.telefone;
        document.getElementById("perfilIdade").textContent = data.idade;
        document.getElementById("perfilEmail").textContent = data.email;
        document.getElementById("perfilSobre").textContent = data.sobre || "";
        document.getElementById("perfilUsername").textContent = data.username || "";
        usernameGlobal = data.username;
        document.getElementById("pontosUsuario").textContent = `${data.pontos || 0} pts`;

        if (data.fotoPerfil) {
          document.getElementById("fotoPerfil").src = data.fotoPerfil;
        }

        // Processa Spotify code apenas uma vez
        const url = new URL(window.location.href);
        const code = url.searchParams.get('code');
        if (code) {
          processSpotifyCode(code, uid)
            .finally(() => {
              // Remove ?code da URL
              window.history.replaceState({}, document.title, url.pathname);
            });
        }
        
        if (outroIdGlobal && outroIdGlobal !== uid) {
          const usuarios = [uid, outroIdGlobal].sort();  
          const matchId = "match_" + usuarios[0] + "_" + usuarios[1];
          abrirChat(matchId, outroIdGlobal, usernameGlobal);
        }






        // Exibe emblemas manuais
        const emblemasContainer = document.getElementById("emblemasContainer");
        emblemasContainer.innerHTML = "";
        if (data.emblemas && Array.isArray(data.emblemas)) {
          data.emblemas.forEach(emblema => {
            const img = document.createElement("img");
            img.src = emblema.imagemUrl;
            img.alt = emblema.descricao || "Emblema manual";
            img.title = emblema.descricao || "";
            img.classList.add("emblema");
            emblemasContainer.appendChild(img);
          });
        }

        // Exibe emblemas autom√°ticos
        const emblemasAutomaticos = atribuirEmblemas(data);
        emblemasAutomaticos.forEach(async emblema => {
          try {
            const storageRef = ref(storage, `autoEmblems/${emblema.nome}`);
            const urlImg = await getDownloadURL(storageRef);
            const img = document.createElement("img");
            img.src = urlImg;
            img.alt = emblema.nome;
            img.title = emblema.descricao;
            img.classList.add("emblema");
            emblemasContainer.appendChild(img);
          } catch {
            console.warn(`Emblema autom√°tico n√£o encontrado: ${emblema.nome}`);
          }
        });

        // Ativa edi√ß√£o de campos
        document.getElementById("editNome").onclick = () => editarCampo("perfilNome", "nome");
        document.getElementById("editCidade").onclick = () => editarCampo("perfilCidade", "cidade");
        document.getElementById("editTelefone").onclick = () => editarCampo("perfilTelefone", "telefone");
        document.getElementById("editIdade").onclick = () => editarCampo("perfilIdade", "idade");
        document.getElementById("editEmail").onclick = () => editarCampo("perfilEmail", "email");
        document.getElementById("editSobre").onclick = () => editarCampo("perfilSobre", "sobre");
        document.getElementById("editUsername").onclick = () => editarCampoUsername("perfilUsername", "username");

        // Exibe o container principal
        document.getElementById("perfilContainer").style.display = "block";
        
        // Listener do upload da foto de perfil
        document.getElementById("btnAlterarFoto").addEventListener("click", () => {
  document.getElementById("uploadFoto").click();
});

document.getElementById("uploadFoto").addEventListener("change", async (event) => {
      const file = event.target.files[0];
      if (file) {
        await uploadFotoPerfil(file, uid); // uid j√° foi obtido acima no onAuthStateChanged
      }
    });


        
        carregarStatusUsuario();
      }
    } catch (error) {
      console.error("Erro ao buscar dados do usu√°rio:", error);
    }
  } else {
    console.log("Nenhum usu√°rio logado");
  }
});

// Secrets

// Refer√™ncias aos elementos
const btnSecrets = document.getElementById('btnSecrets');
const secretsContainer = document.getElementById('secretsContainer');
const enviarSegredoBtn = document.getElementById('enviarSegredo');
const secretsTextarea = document.getElementById('secrets');

// Fun√ß√£o para abrir/fechar o form
btnSecrets.addEventListener('click', () => {
  if (secretsContainer.style.display === 'none') {
    secretsContainer.style.display = 'block';
  } else {
    secretsContainer.style.display = 'none';
    closeAllForms();
  }
});

// Fun√ß√£o para enviar dados para Firestore
enviarSegredoBtn.addEventListener('click', async () => {
  const segredo = secretsTextarea.value.trim();

  if (segredo.length === 0) {
    alert('Por favor, escreva um segredo antes de enviar.');
    return;
  }

  try {
    // Supondo que voc√™ j√° importou e inicializou o Firestore:
    // import { getFirestore, collection, addDoc } from "firebase/firestore";
    // const db = getFirestore();

    const docRef = await addDoc(collection(db, 'secrets'), {
      texto: segredo,
      criadoEm: new Date()
    });

    alert('Segredo enviado com sucesso!');

    // Limpar textarea e fechar o form
    secretsTextarea.value = '';
    secretsContainer.style.display = 'none';

  } catch (error) {
    console.error("Erro ao enviar segredo: ", error);
    alert('Erro ao enviar segredo. Tente novamente.');
  }
});


// Chat

window.abrirChat = function (matchId, outroId, username) {
  const chatContainer = document.getElementById("chatContainer");

  // Alterna a exibi√ß√£o do chat
  if (chatContainer.style.display === "block") {
    chatContainer.style.display = "none";
    return;
  }

  currentMatchId = matchId;
  chatContainer.style.display = "block";
  document.getElementById("chatTitulo").innerText = `Conversando com ${username}`;
  document.getElementById("chatMensagens").innerHTML = "";

  escutarMensagens();
};

async function enviarMensagem() {
  const input = document.getElementById("mensagemInput");
  const texto = input.value.trim();
  if (!texto || !currentMatchId || !uid) return;

  const mensagem = {
    texto,
    remetente: uid,
    timestamp: serverTimestamp()
  };

  const mensagensRef = collection(db, "chats", currentMatchId, "mensagens");
  await addDoc(mensagensRef, mensagem);
  input.value = "";
}

document.getElementById("btnEnviar").addEventListener("click", enviarMensagem);

// Bot√£o de √≠cone dispara input de imagem
document.getElementById("btnIconeImagem").addEventListener("click", () => {
  document.getElementById("imagemInput").click();
});

// Ao escolher uma imagem, envia automaticamente
document.getElementById("imagemInput").addEventListener("change", async () => {
  const fileInput = document.getElementById("imagemInput");
  const file = fileInput.files[0];
  if (!file || !currentMatchId || !uid) return;

  const storageRef = ref(storage, `chatImgs/${currentMatchId}/${Date.now()}_${file.name}`);
  await uploadBytes(storageRef, file);
  const imageUrl = await getDownloadURL(storageRef);

  const mensagem = {
    imagem: imageUrl,
    remetente: uid,
    timestamp: serverTimestamp(),
    expiraEm: Date.now() + 60 * 1000 // 1 minuto
  };

  const mensagensRef = collection(db, "chats", currentMatchId, "mensagens");
  await addDoc(mensagensRef, mensagem);
  fileInput.value = "";
});

function escutarMensagens() {
  if (!currentMatchId || !uid) return;
  if (unsubscribe) unsubscribe();

  const mensagensRef = collection(db, "chats", currentMatchId, "mensagens");
  const mensagensQuery = query(mensagensRef, orderBy("timestamp"));

  unsubscribe = onSnapshot(mensagensQuery, (snapshot) => {
    const chat = document.getElementById("chatMensagens");
    chat.innerHTML = "";

    snapshot.forEach((doc) => {
      const msg = doc.data();
      const agora = Date.now();
      const expira = msg.expiraEm || Infinity;
      if (agora > expira) return;

      const wrapper = document.createElement("div");
    wrapper.className = msg.remetente === uid ? "d-flex justify-content-end mb-2" : "d-flex justify-content-start mb-2";
    
    const msgBox = document.createElement("div");
    msgBox.className = msg.remetente === uid
      ? "bg-primary text-white rounded px-3 py-2"
      : "bg-light text-dark rounded px-3 py-2";
    
    msgBox.style.maxWidth = "75%";
    msgBox.style.display = "inline-block";
    msgBox.style.wordBreak = "break-word";
    
    if (msg.imagem) {
      msgBox.innerHTML = `<img src="${msg.imagem}" style="max-width: 150px; border-radius: 8px;">`;
    } else {
      msgBox.textContent = msg.texto;
    }
    
    wrapper.appendChild(msgBox);
    chat.appendChild(wrapper);
    });

    chat.scrollTop = chat.scrollHeight;
  });
}

// Apenas uma vez, fora da fun√ß√£o escutarMensagens
document.getElementById("btnEnviar").addEventListener("click", enviarMensagem);





// Depoimentos

document.addEventListener("DOMContentLoaded", async () => {
  const btnDepoimentos = document.getElementById("btnDepoimentos");
  const menuDepoimentos = document.getElementById("menuDepoimentos");
  const btnVer = document.getElementById("verDepoimentos");
  const btnEscrever = document.getElementById("escreverDepoimento");

  const form = document.getElementById("formDepoimentos");
  const selectDestino = document.getElementById("usuarioDestino");
  const listaDepoimentos = document.getElementById("listaDepoimentos");
  const containerDepoimentos = document.getElementById("depoimentosContainer");

  const campoBusca = document.createElement("input");
  campoBusca.className = "form-control mb-2";
  campoBusca.placeholder = "Buscar usu√°rio...";
  selectDestino.parentElement.insertBefore(campoBusca, selectDestino);

  let usuariosCarregados = [];

  btnDepoimentos.addEventListener("click", () => {
    document.body.classList.add("bg-depoimentos");
    form.style.display = "none";
    listaDepoimentos.style.display = "none";
  });

  btnVer.addEventListener("click", async () => {
    document.body.classList.add("bg-depoimentos")
    form.style.display = "none";
    listaDepoimentos.style.display = "block";
    await mostrarDepoimentosDoUsuario();
  });

  btnEscrever.addEventListener("click", () => {
    document.body.classList.add("bg-depoimentos")
    form.style.display = "block";
    listaDepoimentos.style.display = "none";
  });

  async function carregarUsuarios() {
    const querySnapshot = await getDocs(collection(db, "usuarios"));
    usuariosCarregados = [];
    selectDestino.innerHTML = `<option selected disabled>Selecione um usu√°rio</option>`;

    querySnapshot.forEach((docSnap) => {
      const data = docSnap.data();
      usuariosCarregados.push({ id: docSnap.id, nome: data.nome || data.usuario || "Sem nome" });
    });

    atualizarSelect(usuariosCarregados);
  }

  function atualizarSelect(lista) {
    selectDestino.innerHTML = `<option selected disabled>Selecione um usu√°rio</option>`;
    lista.forEach((usuario) => {
      const opt = document.createElement("option");
      opt.value = usuario.id;
      opt.textContent = usuario.nome;
      selectDestino.appendChild(opt);
    });
  }

  campoBusca.addEventListener("input", () => {
    const termo = campoBusca.value.toLowerCase();
    const filtrados = usuariosCarregados.filter(u => u.nome.toLowerCase().includes(termo));
    atualizarSelect(filtrados);
  });

  await carregarUsuarios();
  
  // badgeDepoimentos
  
  async function verificarDepoimentosNovos() {
  const user = auth.currentUser;
  if (!user) return;

  const userRef = doc(db, "usuarios", user.uid);
  const docSnap = await getDoc(userRef);
  if (!docSnap.exists()) return;

  const data = docSnap.data();
  const temDepoimentos = (data.depoimentos || []).length > 0;
  document.getElementById("badgeDepoimentos").style.display = temDepoimentos ? "inline-block" : "none";
}

auth.onAuthStateChanged(() => {
  verificarDepoimentosNovos();
});

// Exclus√£o

async function excluirDepoimento(titulo, de, texto) {
  const user = auth.currentUser;
  if (!user) return;

  const userRef = doc(db, "usuarios", user.uid);
  const docSnap = await getDoc(userRef);
  if (!docSnap.exists()) return;

  const data = docSnap.data();
  const novosDepoimentos = (data.depoimentos || []).filter(dep =>
    dep.titulo !== titulo || dep.de !== de || dep.texto !== texto
  );

  await updateDoc(userRef, {
    depoimentos: novosDepoimentos
  });

  alert("Depoimento exclu√≠do!");
  mostrarDepoimentosDoUsuario(); // Atualiza a lista
}


  // Enviar depoimento
 form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const titulo = document.getElementById("tituloDepoimento").value.trim();
  const remetente = document.getElementById("usuarioDepoente").value.trim();
  const destinoId = selectDestino.value;
  const texto = document.getElementById("textoDepoimento").value.trim();

  if (!titulo || !remetente || !destinoId || !texto) {
    alert("Por favor, preencha todos os campos.");
    return;
  }

  try {
    const destinoRef = doc(db, "usuarios", destinoId);
    const destinoSnap = await getDoc(destinoRef);
    const destinoData = destinoSnap.data();

    // Incrementa o contador (padr√£o: 0)
    const novoContador = (destinoData.contadorDepoimentosRecebidos || 0) + 1;

    await updateDoc(destinoRef, {
      depoimentos: arrayUnion({
        titulo,
        de: remetente,
        texto,
        data: new Date().toISOString()
      }),
      contadorDepoimentosRecebidos: novoContador
    });

    // Conceder emblema se necess√°rio
    await concederEmblemasProgresso(destinoId, "depoimento", novoContador);

    alert("Depoimento enviado com sucesso!");
    form.reset();
    form.style.display = "none";
  } catch (error) {
    console.error("Erro ao enviar depoimento:", error);
    alert("Erro ao enviar depoimento.");
  }
});


 async function mostrarDepoimentosDoUsuario() {
  const user = auth.currentUser;
  if (!user) {
    alert("Voc√™ precisa estar logado para ver seus depoimentos.");
    return;
  }

  const userRef = doc(db, "usuarios", user.uid);
  const docSnap = await getDoc(userRef);

  if (!docSnap.exists()) {
    containerDepoimentos.innerHTML = "<p>Usu√°rio n√£o encontrado.</p>";
    return;
  }

  const data = docSnap.data();
  const depoimentos = data.depoimentos || [];

  if (depoimentos.length === 0) {
    containerDepoimentos.innerHTML = '<p class="text-center">Voc√™ ainda n√£o recebeu depoimentos.</p>';
    await verificarDepoimentosNovos();
    return;
  }

  containerDepoimentos.innerHTML = "";
  depoimentos.forEach(dep => {
    const div = document.createElement("div");
    div.className = "mb-3 border rounded p-2";
    div.innerHTML = `
      <h6 class="text-paragrafo">${dep.titulo}</h6>
      <small class="text-paragrafo"><strong>De:</strong> ${dep.de}</small>
      <p class="text-paragrafo">${dep.texto}</p>
    `;

    const botaoExcluir = document.createElement("button");
    botaoExcluir.className = "btn btn-sm btn-danger mt-2";
    botaoExcluir.innerHTML = '<i class="bi bi-trash"></i> Excluir';
    botaoExcluir.addEventListener("click", async () => {
      await excluirDepoimento(dep.titulo, dep.de, dep.texto);
    });

    div.appendChild(botaoExcluir);
    containerDepoimentos.appendChild(div);
  });

  await verificarDepoimentosNovos(); // Atualiza o badge ap√≥s visualizar
}});


// Pega√ß√£o

const selectUsuarios = document.getElementById("selectUsuarios");
const formTestarQuimica = document.getElementById("formTestarQuimica");
const btnTestarQuimica = document.getElementById("btnTestarQuimica");
const contadorDisponiveis = document.getElementById("contadorDisponiveis");
const statusUsuarioSelect = document.getElementById("statusUsuario");
const convitesContainer = document.getElementById("convitesContainer");

async function atualizarContador(userId, tipo) {
  const userRef = doc(db, "usuarios", userId);
  const userSnap = await getDoc(userRef);

  // Se o documento do usu√°rio ainda n√£o existe, cria com o contador inicial
  if (!userSnap.exists()) {
    await setDoc(userRef, {
      contadores: {
        [tipo]: 1
      }
    }, { merge: true });
    return;
  }

  // Se j√° existe, incrementa o campo desejado
  await updateDoc(userRef, {
    [`contadores.${tipo}`]: increment(1)
  });
}

async function carregarStatusUsuario() {
  const user = auth.currentUser;
  if (!user) return;

  const userRef = doc(db, "usuarios", user.uid);
  const userSnap = await getDoc(userRef);

  if (userSnap.exists()) {
    const dados = userSnap.data();
    const status = dados.disponivelParaPegacao;

    if (status === true) {
      statusUsuarioSelect.value = "true";
    } else if (status === false) {
      statusUsuarioSelect.value = "false";
    } else {
      statusUsuarioSelect.selectedIndex = 0; // seleciona "Status"
    }
  }}


// Atualizar status de disponibilidade
statusUsuarioSelect.addEventListener("change", async () => {
  const user = auth.currentUser;
  if (!user) {
    alert("Usu√°rio n√£o autenticado.");
    return;
  }

  const userRef = doc(db, "usuarios", user.uid);
  const disponivel = statusUsuarioSelect.value === "true";

  try {
    await updateDoc(userRef, {
      disponivelParaPegacao: disponivel
    });

    alert(`Status atualizado para: ${disponivel ? "Dispon√≠vel" : "Indispon√≠vel"}`);
    carregarUsuariosDisponiveis();
  } catch (error) {
    alert("Erro ao atualizar status.");
    console.error(error);
  }
});

// Mostrar ou ocultar o formul√°rio
btnTestarQuimica.addEventListener("click", () => {
  document.body.classList.add("bg-testar-quimica");
  convitesContainer.style.display = "none";
  formTestarQuimica.style.display = formTestarQuimica.style.display === "none" ? "block" : "none";
});

// Carregar usu√°rios dispon√≠veis
async function carregarUsuariosDisponiveis() {
  const q = query(collection(db, "usuarios"), where("disponivelParaPegacao", "==", true));
  const querySnapshot = await getDocs(q);

    let contador = 0;
    const usuariosAdicionados = new Set();
    selectUsuarios.innerHTML = `<option selected disabled>Selecionar usu√°rio</option>`;
    
    for (const docSnap of querySnapshot.docs) {
      const userId = docSnap.id;
    
      if (usuariosAdicionados.has(userId)) continue;
      usuariosAdicionados.add(userId);
    
      const user = docSnap.data();
      const option = document.createElement("option");
      const sobre = user.sobre || "Sem descri√ß√£o";

    
      let fotoURL = "";
      try {
        fotoURL = await getDownloadURL(storageRef(storage, `fotosPerfil/${userId}.jpg`));
      } catch (e) {
        // Foto n√£o encontrada
      }
      option.dataset.sobre = sobre;
      option.value = userId;
      option.textContent = `${user.username} (${user.status || "Dispon√≠vel"})`;
      if (fotoURL) option.dataset.foto = fotoURL;
      selectUsuarios.appendChild(option);
    
      contador++;
    }

    
    contadorDisponiveis.textContent = `üü¢ ${contador} usu√°rios dispon√≠veis para pega√ß√£o`

}

selectUsuarios.addEventListener("change", () => {
  const selectedOption = selectUsuarios.selectedOptions[0];
  const fotoURL = selectedOption.dataset.foto;
  const nome = selectedOption.textContent;
  const sobre = selectedOption.dataset.sobre || "Sem descri√ß√£o";

  const previewDiv = document.getElementById("previewUsuarioSelecionado");

  const imagemHTML = fotoURL
    ? `<img src="${fotoURL}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-right: 10px;">`
    : `üë§`;

  previewDiv.innerHTML = `
    ${imagemHTML} <strong>${nome}</strong><br>
    <br>
  <div style="margin-top: 4px; font-size: 0.9em; color: #555;"><strong>Descri√ß√£o:</strong> ${sobre}</div>
  `;
});



// Enviar convite
formTestarQuimica.addEventListener("submit", async (e) => {
  e.preventDefault();
    console.log("form submit acionado"); // <--- adicione isso
console.log("Usu√°rio atual:", auth.currentUser);


  try {
    const currentUser = auth.currentUser;
    const fromId = currentUser.uid;
    const toId = selectUsuarios.value;

    if (!toId || fromId === toId) {
      alert("Selecione um usu√°rio v√°lido.");
      return;
    }

    const q = query(
      collection(db, "pegacoes"),
      where("from", "==", toId),
      where("to", "==", fromId)
    );

    const snapshot = await getDocs(q);
    let match = false;

   if (!snapshot.empty) {
  match = true;

  for (const docSnap of snapshot.docs) {
    await updateDoc(doc(db, "pegacoes", docSnap.id), { match: true });
  }

  await atualizarContador(fromId, "enviados");
  await atualizarContador(toId, "recebidos");
  await atualizarPegacaoStats(fromId, "enviados");
  await atualizarPegacaoStats(toId, "recebidos");

  alert("‚ú® Deu match!");
} else {
  // Se n√£o havia convite anterior, crie um novo
  await addDoc(collection(db, "pegacoes"), {
    from: fromId,
    to: toId,
    timestamp: serverTimestamp(),
    match: false,
  });

  alert("Hop enviado!");

    }
    
    if (match) {
      await atualizarPegacaoStats(fromId, "matches");
      await atualizarPegacaoStats(toId, "matches");
    }

    formTestarQuimica.reset();
    formTestarQuimica.style.display = "none";
  } catch (error) {
    console.error("Erro ao tentar criar/atualizar a cole√ß√£o 'pegacoes':", error);
    alert("Erro ao enviar o hop. Veja o console para mais detalhes.");
  }
});


let outroIdGlobal = null;
let usernameGlobal = null;


// Carregar convites
document.getElementById("verEnviados").addEventListener("click", () => {
  formTestarQuimica.style.display = "none";
  convitesContainer.style.display = "block";
  document.body.classList.add("bg-testar-quimica");
  carregarConvites("enviados");
});

document.getElementById("verRecebidos").addEventListener("click", () => {
  formTestarQuimica.style.display = "none";
  document.body.classList.add("bg-testar-quimica");
  convitesContainer.style.display = "block";
  carregarConvites("recebidos");
});
async function carregarConvites(tipo) {
  const currentUser = auth.currentUser;
  if (!currentUser) return;

  // Limpar o container antes de carregar os convites
  convitesContainer.innerHTML = "<p>Carregando...</p>";

  const filtro = tipo === "enviados" ? "from" : "to";
  const q = query(collection(db, "pegacoes"), where(filtro, "==", currentUser.uid));
  const querySnapshot = await getDocs(q);

  if (querySnapshot.empty) {
    convitesContainer.innerHTML = "<p>Nenhum convite encontrado.</p>";
    return;
  }

  convitesContainer.innerHTML = ""; // Limpar o container

  for (const docSnap of querySnapshot.docs) {
    const dados = docSnap.data();
    const outroId = tipo === "enviados" ? dados.to : dados.from;
    outroIdGlobal = outroId;
    const outroDoc = await getDoc(doc(db, "usuarios", outroId));
    const outroData = outroDoc.exists() ? outroDoc.data() : {};
    const outroNome = outroData.username || "Usu√°rio";
    const fotoPerfil = outroData.fotoPerfil || "default.jpg";


    const div = document.createElement("div");
    div.className = "card p-3 mb-2";
    div.innerHTML = `
     <div class="d-flex align-items-center justify-content-between mb-2">
  <div class="d-flex align-items-center">
    <img src="${fotoPerfil}" alt="Foto de ${outroNome}" class="rounded-circle me-3" width="50" height="50">
    <p class="mb-0"><strong>${tipo === "enviados" ? "Para" : "De"}:</strong> ${outroNome}</p>
  </div>
  ${tipo === "recebidos" ? `
    <div>
      <button class="btn  btn-sm me-1" onclick="responderConvite('${docSnap.id}', true)">‚úÖ</button>
      <button class="btn btn-sm" onclick="responderConvite('${docSnap.id}', false)">‚ùå</button>
    </div>
  ` : `
    <button class="btn btn-outline-danger btn-sm" onclick="deletarConvite('${docSnap.id}')">Cancelar</button>
  `}
</div>
${dados.match ? "<p class='text-success'>‚ú® Match!</p>" : ""}
    `;
    convitesContainer.appendChild(div);
  }
}

const matchesContainer = document.getElementById("matchesContainer");

document.getElementById("verMatches").addEventListener("click", () => {
  formTestarQuimica.style.display = "none";
  convitesContainer.style.display = "none";
  matchesContainer.style.display = "block";
  carregarMatches();
});

async function carregarMatches() {
  const currentUser = auth.currentUser;
  if (!currentUser) return;

  matchesContainer.innerHTML = "<p>Carregando matches...</p>";
  const userId = currentUser.uid;

  try {
    const qFrom = query(collection(db, "pegacoes"), where("from", "==", userId), where("match", "==", true));
    const qTo = query(collection(db, "pegacoes"), where("to", "==", userId), where("match", "==", true));

    const [fromSnap, toSnap] = await Promise.all([getDocs(qFrom), getDocs(qTo)]);
    const allMatches = [...fromSnap.docs, ...toSnap.docs];

    matchesContainer.innerHTML = "";
    if (allMatches.length === 0) {
      matchesContainer.innerHTML = "<p>Voc√™ ainda n√£o deu match com ningu√©m. üò¢</p>";
      return;
    }

    const matchSet = new Set();

    for (const docSnap of allMatches) {
      const dados = docSnap.data();
      const matchId = docSnap.id;
      const outroId = dados.from === userId ? dados.to : dados.from;

      // Cria uma chave √∫nica ordenada
      const key = [userId, outroId].sort().join("_");
      if (matchSet.has(key)) continue; // j√° exibido
      matchSet.add(key);

      const outroDoc = await getDoc(doc(db, "usuarios", outroId));
      if (!outroDoc.exists()) continue;

      const { username, telefone, fotoPerfil } = outroDoc.data();

      const div = document.createElement("div");
      div.className = "card p-3 mb-2";
      div.innerHTML = `
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="d-flex align-items-center">
            <img src="${fotoPerfil || 'default.jpg'}" alt="Foto de ${username}" class="rounded-circle me-3" width="80" height="80">
            <div>
              <p class="mb-1"><strong>${username}</strong></p>
              <p class="mb-0"><strong>Telefone:</strong> ${telefone || "N√£o informado"}</p>
            </div>
          </div>
          <div>
            <button class="btn btn-sm btn-success me-2" onclick="abrirChat('${matchId}', '${outroId}', '${username}')">üí¨ Conversar</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deletarMatch('${matchId}')">‚ùå Remover match</button>
          </div>
        </div>
      `;
      matchesContainer.appendChild(div);
    }

  } catch (error) {
    console.error("Erro ao carregar matches:", error);
    matchesContainer.innerHTML = "<p>Erro ao carregar matches. Veja o console.</p>";
  }
}


window.excluirMatch = async function (matchId) {
  await deleteDoc(doc(db, "pegacoes", matchId));
  alert("Match exclu√≠do.");
  carregarMatches();
};


// ‚úÖ Tornar fun√ß√µes acess√≠veis globalmente
window.responderConvite = async function (id, aceito) {
  if (aceito) {
    await updateDoc(doc(db, "pegacoes", id), { match: true });

    // Criar reciprocidade se quiser
    const dados = (await getDoc(doc(db, "pegacoes", id))).data();
    await addDoc(collection(db, "pegacoes"), {
      from: dados.to,
      to: dados.from,
      timestamp: serverTimestamp(),
      match: true
    });

    alert("Convite aceito! ‚ù§Ô∏è");
  } else {
    await deleteDoc(doc(db, "pegacoes", id));
    alert("Convite recusado!");
  }

  carregarConvites("recebidos"); // Atualiza a lista ap√≥s a resposta
};

window.deletarConvite = async function (id) {
  await deleteDoc(doc(db, "pegacoes", id));
  alert("Convite cancelado.");
  carregarConvites("enviados");
};

// Chamar ao carregar a p√°gina
carregarUsuariosDisponiveis();

async function verificarEmblemas(userId, tipo, total) {
  const emblemasRef = collection(db, "usuarios", userId, "emblemas");
  const tipos = {
    enviados: "pegacao",
    recebidos: "pegacaoRecebidos",
    matches: "pegacaoMatch"
  };

  const tipoBase = tipos[tipo];
  const marcos = [1, 5, 20];

  for (const marco of marcos) {
    const id = `${tipoBase}${marco}`;
    const docRef = doc(emblemasRef, id);
    const docSnap = await getDoc(docRef);

    if (!docSnap.exists() && total >= marco) {
      await setDoc(docRef, {
        nome: id,
        data: serverTimestamp(),
        imagem: `${tipoBase}${marco}.jpg`
      });
    }
  }
}

async function atualizarPegacaoStats(uid, tipo) {
  const userRef = doc(db, "usuarios", uid);
  const userSnap = await getDoc(userRef);
  let stats = {};

  if (userSnap.exists()) {
    stats = userSnap.data().pegacaoStats || {
      enviados: 0,
      recebidos: 0,
      matches: 0
    };

    stats[tipo] = (stats[tipo] || 0) + 1;

    await updateDoc(userRef, { pegacaoStats: stats });

    // Verifica e concede emblemas
    const marco = stats[tipo];
    if ([1, 5, 20].includes(marco)) {
      const emblemaRef = doc(db, "usuarios", uid, "emblemas", "pegacao" + marco);
      const emblemaSnap = await getDoc(emblemaRef);
      if (!emblemaSnap.exists()) {
        await setDoc(emblemaRef, {
          tipo: "pegacao",
          nome: `Pega√ß√£o ${marco}`,
          imagem: `pegacao${marco}.jpg`,
          data: serverTimestamp()
        });
      }
    }
  }
}






const painelUsuario = document.querySelector(".painel-usuario");
document.addEventListener("DOMContentLoaded", () => {
  const formCorreioElegante = document.getElementById("formCorreioElegante");
  const formBug = document.getElementById("formBug");
  const formTemplate = document.getElementById("formTemplate");
  const formConfirmarPresenca = document.getElementById("formConfirmarPresenca");
  const perfilContainer = document.getElementById("perfilContainer");
  const formTestarQuimica = document.getElementById("formTestarQuimica");

  function closeAllForms() {
    if (formCorreioElegante) formCorreioElegante.style.display = "none";
    if (formBug) formBug.style.display = "none";
    if (formTemplate) formTemplate.style.display = "none";
    if (formConfirmarPresenca) formConfirmarPresenca.style.display = "none";
    if (perfilContainer) perfilContainer.style.display = "none";
    if (formTestarQuimica) formTestarQuimica.style.display = "none";

    const menuDepoimentos = document.getElementById("menuDepoimentos");
    const formDepoimentos = document.getElementById("formDepoimentos");
    const listaDepoimentos = document.getElementById("listaDepoimentos");
    const containerDepoimentos = document.getElementById("depoimentosContainer");

    if (formDepoimentos) formDepoimentos.style.display = "none";
    if (menuDepoimentos) menuDepoimentos.style.display = "none";
    if (listaDepoimentos) listaDepoimentos.style.display = "none";
    if (containerDepoimentos) containerDepoimentos.innerHTML = "";

    document.body.classList.remove(
      "bg-correio-elegante",
      "bg-relatar-bug",
      "bg-criar-template",
      "bg-confirmar-presenca",
      "bg-editar-perfil",
      "bg-emblemas",
      "bg-depoimentos",
      "bg-testar-quimica"
    );
  }

  document.getElementById("btnEnviarCorreioElegante").addEventListener("click", function () {
    const isVisible = formCorreioElegante.style.display === "block";
    closeAllForms();
    document.body.classList.add("bg-correio-elegante");
    formCorreioElegante.style.display = isVisible ? "none" : "block";
  });

  document.getElementById("relatarBugBtn").addEventListener("click", function () {
    const isVisible = formBug.style.display === "block";
    closeAllForms();
    document.body.classList.add("bg-relatar-bug");
    formBug.style.display = isVisible ? "none" : "block";
  });

  document.getElementById("btnCriarTemplate").addEventListener("click", function () {
    const isVisible = formTemplate.style.display === "block";
    closeAllForms();
    document.body.classList.add("bg-criar-template");
    formTemplate.style.display = isVisible ? "none" : "block";
  });

  const btnConfirmarPresenca = document.getElementById("btnConfirmarPresenca");
  if (btnConfirmarPresenca) {
    btnConfirmarPresenca.addEventListener("click", function () {
      const isVisible = formConfirmarPresenca.style.display === "block";
      closeAllForms();
      document.body.classList.add("bg-confirmar-presenca");
      formConfirmarPresenca.style.display = isVisible ? "none" : "block";
    });
  }

  const btnVerPerfil = document.getElementById("btnVerPerfil");
  if (btnVerPerfil) {
    btnVerPerfil.addEventListener("click", function () {
      const isVisible = perfilContainer.style.display === "block";
      closeAllForms();
      perfilContainer.style.display = isVisible ? "none" : "block";
      document.body.classList.add("bg-editar-perfil");
    });
  }

  const btnEmblemas = document.getElementById("btnEmblemas");
    if (btnEmblemas) {
    btnEmblemas.addEventListener("click", function () {
    const emblemasSection = document.getElementById("emblemasSection");

    const isHidden = emblemasSection.style.display === "none" || emblemasSection.style.display === "";

    if (isHidden) {
      emblemasSection.style.display = "block";
      document.body.classList.add("bg-emblemas");
      closeAllForms();
    } else {
      emblemasSection.style.display = "none";
      document.body.classList.remove("bg-emblemas");
    }
  });
}


});


function atribuirEmblemas(user) {
  const emblemas = [];
  const descricoesEmblemas = {
    "emblemaVeterano.jpg": "Recebeu o emblema de veterano por alcan√ßar 50 pontos.",
    "emblemaExplorador.jpg": "Recebeu o emblema de explorador por alcan√ßar 30 pontos.",
    "emblemaIniciante.jpg": "Recebeu o emblema de iniciante por alcan√ßar 10 pontos."
  };

  if (user.pontos >= 50) {
    emblemas.push({ nome: 'emblemaVeterano.jpg', descricao: descricoesEmblemas["emblemaVeterano.jpg"] });
  }
  if (user.pontos >= 30) {
    emblemas.push({ nome: 'emblemaExplorador.jpg', descricao: descricoesEmblemas["emblemaExplorador.jpg"] });
  }
  if (user.pontos >= 10) {
    emblemas.push({ nome: 'emblemaIniciante.jpg', descricao: descricoesEmblemas["emblemaIniciante.jpg"] });
  }

  return emblemas;
}


async function concederEmblemaUnico(userId, userData, tipo) {
  const jaTem = userData.emblemasUnicosRecebidos?.includes(tipo);
  if (jaTem) return;

  const emblemasInfo = {
    bug: {
      descricao: "Relatou um bug",
      arquivo: "bug.jpg"
    },
    correio: {
      descricao: "Enviou um correio elegante",
      arquivo: "correio.jpg"
    },
    template: {
      descricao: "Criou um template",
      arquivo: "template.jpg"
    }
  };

  const info = emblemasInfo[tipo];
  if (!info) return;

  try {
    const storageRef = ref(storage, `autoEmblems/${info.arquivo}`);
    const imagemUrl = await getDownloadURL(storageRef);

    await updateDoc(doc(db, "usuarios", userId), {
      emblemas: arrayUnion({
        descricao: info.descricao,
        imagemUrl: imagemUrl
      }),
      emblemasUnicosRecebidos: arrayUnion(tipo)
    });

    alert(`Voc√™ recebeu o emblema: ${info.descricao}`);
  } catch (error) {
    console.error("Erro ao conceder emblema √∫nico:", error);
  }
}

async function concederEmblemasProgresso(userId, tipo, novaContagem) {
  const emblemasPorTipo = {
    depoimento: {
      1: "depoimento1.jpeg",
      5: "depoimento5.jpeg",
      20: "depoimento20.jpeg"
    },
    pegacaoEnviada: {
      1: "pegacao1env.jpeg",
      5: "pegacao5env.jpeg",
      20: "pegacao20env.jpeg"
    },
    pegacaoRecebida: {
      1: "pegacao1rec.jpeg",
      5: "pegacao5rec.jpeg",
      20: "pegacao20rec.jpeg"
    },
    match: {
      1: "match1.jpeg",
      5: "match5.jpeg",
      20: "match20.jpeg"
    }
  };

  const emblemas = emblemasPorTipo[tipo];
  if (!emblemas || !emblemas[novaContagem]) return;

  const imagemNome = emblemas[novaContagem];
  const storageRef = ref(storage, `autoEmblems/${imagemNome}`);
  const imagemUrl = await getDownloadURL(storageRef);

  const userRef = doc(db, "usuarios", userId);
  const userSnap = await getDoc(userRef);
  const userData = userSnap.data();

  const jaRecebido = userData?.emblemasRecebidosProgresso?.includes(imagemNome);
  if (jaRecebido) return;

  await updateDoc(userRef, {
    emblemas: arrayUnion({
      descricao: `Recebeu emblema por ${tipo} ${novaContagem}x.`,
      imagemUrl: imagemUrl
    }),
    emblemasRecebidosProgresso: arrayUnion(imagemNome)
  });

  alert(`Voc√™ recebeu um novo emblema por ${tipo} ${novaContagem}x!`);
}




document.getElementById("correioForm").addEventListener("submit", async function(event) {
  event.preventDefault();

  const destinatario = document.getElementById("destinatario").value;
  const remetente = document.getElementById("remetente").value;
  const mensagem = document.getElementById("mensagem").value;

  try {
    await addDoc(collection(db, "correioElegante"), {
      destinatario,
      remetente,
      mensagem,
      timestamp: serverTimestamp(),
    });

    document.getElementById("correioStatus").style.display = "block";
    document.getElementById("correioForm").reset();

    const userId = auth.currentUser.uid;
    const userSnap = await getDoc(doc(db, "usuarios", userId));
    const userData = userSnap.data();
    await concederEmblemaUnico(userId, userData, "correio");
  } catch (error) {
    console.error("Erro ao enviar correio elegante", error);
  }
});

document.getElementById("bugForm").addEventListener("submit", async function(event) {
  event.preventDefault();

  const titulo = document.getElementById("titulo").value;
  const descricao = document.getElementById("descricao").value;

  try {
    await addDoc(collection(db, "bugs"), {
      titulo,
      descricao,
      timestamp: serverTimestamp(),
    });

    document.getElementById("bugStatus").style.display = "block";
    document.getElementById("bugForm").reset();

    const userId = auth.currentUser.uid;
    const userSnap = await getDoc(doc(db, "usuarios", userId));
    const userData = userSnap.data();
    await concederEmblemaUnico(userId, userData, "bug");
  } catch (error) {
    console.error("Erro ao relatar bug", error);
  }
});


async function getImageAsBase64(storagePath) {
  const url = await getDownloadURL(ref(storage, storagePath));
  const response = await fetch(url);
  const blob = await response.blob();

  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result);
    reader.readAsDataURL(blob);
  });
}

document.getElementById("gerarTemplate").addEventListener("click", async function () {
  const nome = document.getElementById("nome").value;
  const idade = document.getElementById("idade").value;
  const aniversario = document.getElementById("aniversario").value;
  const signo = document.getElementById("signo").value;
  const altura = document.getElementById("altura").value;
  const cidadeBairro = document.getElementById("cidadeBairro").value;
  const estadoCivil = document.getElementById("estadoCivil").value;
  const hobbies = document.getElementById("hobbies").value;
  const instagram = document.getElementById("instagram").value;

  const conteudo = `
OL√Å MENINOS, TUDO BOM?!

NOVATOS SEJAM BEM VINDOS ü©µ

Pedimos a todos que se apresente com foto, e que sigam as regras do grupo (importante ter a foto do perfil aberta a todos) ‚ù§

üòá NOME: ${nome}
‚è≥ IDADE: ${idade}
ü•≥ ANIVERS√ÅRIO: ${aniversario}
‚ù§ SIGNO: ${signo}
‚¨Ü ALTURA: ${altura}
üì¨ CIDADE E BAIRRO SP: ${cidadeBairro}
‚ù§ ESTADO CIVIL: ${estadoCivil}
üéÆ HOBBIES: ${hobbies}
üì∏ INSTA: ${instagram}
`;

  const resultadoTemplate = document.getElementById("resultadoTemplate");
  resultadoTemplate.textContent = conteudo;
  resultadoTemplate.style.display = "block";

  document.getElementById("formTemplate").style.display = "none";
  document.getElementById("copiarTexto").style.display = "inline-block";

  if (typeof db !== "undefined") {
    try {
      await addDoc(collection(db, "templates"), {
        nome,
        idade,
        aniversario,
        signo,
        altura,
        cidadeBairro,
        estadoCivil,
        hobbies,
        instagram,
        timestamp: serverTimestamp(),
      });

      const userId = auth.currentUser.uid;
      const userSnap = await getDoc(doc(db, "usuarios", userId));
      const userData = userSnap.data();
      await concederEmblemaUnico(userId, userData, "template");
    } catch (error) {
      console.error("Erro ao criar template", error);
    }
  }

  document.getElementById("templateForm").reset();
});


document.getElementById("copiarTexto").addEventListener("click", function () {
  const texto = document.getElementById("resultadoTemplate").textContent;
  navigator.clipboard.writeText(texto)
    .then(() => alert("Texto copiado com sucesso!"))
    .catch(() => alert("Erro ao copiar o texto."));
});


  // Confirmar Presen√ßa
  getDocs(collection(db, "roles"))
  .then((querySnapshot) => {
    if (!querySnapshot.empty) {
      const roleDoc = querySnapshot.docs[0];
      const roleData = roleDoc.data();

      document.getElementById("nomeRole").textContent = roleData.nomeRole;
      document.getElementById("dataRole").textContent = roleData.dataRole;

      const container = document.getElementById("formConfirmarPresenca");
      container.dataset.nomeRole = roleData.nomeRole;
      container.dataset.dataRole = roleData.dataRole;
      container.dataset.idRole = roleDoc.id;
    }
  })
  .catch((error) => {
    console.error("Erro ao buscar rol√™:", error);
  });

// Evento bot√£o "Vou"
document.getElementById("btnVou").addEventListener("click", async () => {
  const container = document.getElementById("formConfirmarPresenca");
  const idRole = container.dataset.idRole;

  const user = auth.currentUser;
  if (!user) {
    alert("Voc√™ precisa estar logado para confirmar presen√ßa.");
    return;
  }

  try {
    // Busca dados do usu√°rio logado na cole√ß√£o 'usuarios'
    const q = query(collection(db, "usuarios"), where("userId", "==", user.uid));
    const querySnapshot = await getDocs(q);

    if (querySnapshot.empty) {
      alert("Dados do usu√°rio n√£o encontrados.");
      return;
    }

    const userData = querySnapshot.docs[0].data();

    await addDoc(collection(db, "pessoas"), {
      nome: userData.nome || "sem nome",
      cidade: userData.cidade || "sem cidade",
      idRole: idRole
    });

    document.getElementById("presencaStatus").style.display = "block";
  } catch (error) {
    console.error("Erro ao confirmar presen√ßa", error);
    alert("Erro ao confirmar presen√ßa. Tente novamente.");
  }
});

// Evento bot√£o "N√£o vou"
document.getElementById("btnNaoVou").addEventListener("click", () => {
    document.getElementById("presencaStatusNao").style.display = "block";
});


const forms = [formCorreioElegante, formBug, formTemplate, formConfirmarPresenca,];

forms.forEach(form => {
  form.addEventListener("transitionend", function () {
    painelUsuario.classList.remove("bg-correio-elegante", "bg-relatar-bug", "bg-criar-template", "bg-confirmar-presenca", "bg-editar-perfil", "bg-emblemas", "bg-testar-quimica", "bg-depoimentos"
    );
    painelUsuario.classList.add("painel-usuario-bg")
  });
});

const botoes = [
  { id: 'btnEnviarCorreioElegante', classe: 'bg-correio-elegante' },
  { id: 'relatarBugBtn', classe: 'bg-relatar-bug' },
  { id: 'btnConfirmarPresenca', classe: 'bg-confirmar-presenca' },
  { id: 'btnCriarTemplate', classe: 'bg-criar-template' },
  { id: 'btnVer', classe: 'bg-depoimentos'},
  { id: 'btnEscrever', classe: 'bg-depoimentos'},
  { id: 'btnDepoimentos', classe: 'bg-depoimentos'},
  { id: 'btnTestarQuimica', classe: 'bg-testar-quimica'},
  { id: 'verRecebidos', classe: 'bg-testar-quimica'},
  { id: 'verEnviados', classe: 'bg-testar-quimica'},
  { id: 'btnEmblemas', classe: 'bg-emblemas'}
];

// Container do painel

// L√≥gica para limpar classes e aplicar a nova
botoes.forEach(botao => {
  const elemento = document.getElementById(botao.id);
  if (elemento) {
    elemento.addEventListener('click', () => {
      painelUsuario.classList.remove(
        'bg-correio-elegante',
        'bg-relatar-bug',
        'bg-confirmar-presenca',
        'bg-criar-template',
        'bg-editar-perfil',
        'bg-emblemas',
        'bg-depoimentos',
        'bg-testar-quimica'
      );
      painelUsuario.classList.add(botao.classe);
    });
  }
});
</script>

</body>
</html>